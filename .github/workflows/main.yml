name: camera_ros build

on: [push, pull_request]

jobs:
  build:
    name: camera_ros (${{ matrix.distribution }})
    runs-on: ubuntu-latest
    # Test on the latest LTS and current version ('rolling'),
    # but only require to pass on LTS distributions.
    strategy:
      matrix:
        distribution: ["foxy", "rolling"]
    continue-on-error: ${{ matrix.distribution == 'rolling' }}

    steps:
      - name: install libcamera dependencies
        run: |
          sudo apt install python3-pip ninja-build python3-yaml python3-ply python3-jinja2 libgnutls28-dev
          sudo pip3 install meson

      - name: fetch source
        uses: actions/checkout@v2

      - name: install ROS2 ${{ matrix.distribution }}
        uses: ros-tooling/setup-ros@0.2.1
        with:
          required-ros-distributions: ${{ matrix.distribution }}

      - name: build and test
        uses: ros-tooling/action-ros-ci@v0.2
        with:
          package-name: camera_ros
          target-ros2-distro: ${{ matrix.distribution }}
          vcs-repo-file-url: .github/repo.yaml
          colcon-defaults: |
            {
              "build": {
                "mixin": ["asan-gcc"]
              }
            }
          colcon-mixin-repository: https://raw.githubusercontent.com/colcon/colcon-mixin-repository/3e627e0fa30db85aea05a50e2c61a9832664d236/index.yaml
